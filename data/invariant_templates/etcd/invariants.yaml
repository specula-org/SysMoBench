# Simplified Invariants for etcd/Raft Systems

invariants:
  - name: "LeaderUniqueness"
    type: "safety"
    natural_language: "At most one leader can exist in any given term across all nodes in the cluster"
    formal_description: "For any given term T, there can be at most one node in the cluster that considers itself the leader for that term. This is fundamental to the safety of Raft."
    tla_example: |
      LeaderUniqueness == 
        \A term \in Terms :
          Cardinality({n \in Nodes : 
            /\ serverState[n] = Leader
            /\ currentTerm[n] = term}) <= 1
    
  - name: "LogConsistency" 
    type: "safety"
    natural_language: "If two logs contain an entry with the same index and term, then the logs are identical up to that index"
    formal_description: "The Raft log consistency property: if two different nodes have log entries with the same index and term, then their logs are identical in all preceding entries."
    tla_example: |
      LogConsistency ==
        \A n1, n2 \in Nodes :
          \A idx \in Nat :
            /\ idx \in DOMAIN log[n1] 
            /\ idx \in DOMAIN log[n2]
            /\ log[n1][idx].term = log[n2][idx].term
            => \A j \in 1..idx : log[n1][j] = log[n2][j]

  - name: "LeaderCompletenessProperty"
    type: "safety"
    natural_language: "If a log entry is committed in a given term, then that entry will be present in the logs of the leaders for all higher-numbered terms"
    formal_description: "Once an entry is committed, it must appear in all future leader logs. This ensures that committed entries are never lost or overwritten."
    tla_example: |
      LeaderCompletenessProperty ==
        \A commitTerm \in Terms, commitIdx \in Nat :
          \A leaderTerm \in Terms, leader \in Nodes :
            /\ leaderTerm > commitTerm
            /\ serverState[leader] = Leader  
            /\ currentTerm[leader] = leaderTerm
            /\ IsCommitted(commitIdx, commitTerm)
            => /\ commitIdx \in DOMAIN log[leader]
               /\ log[leader][commitIdx].term = commitTerm

  - name: "StateMachineSafety"
    type: "safety"
    natural_language: "All nodes apply the same sequence of committed log entries to their state machines"
    formal_description: "State machine safety ensures that all nodes that have applied log entries up to the same index have applied exactly the same sequence of entries."
    tla_example: |
      StateMachineSafety ==
        \A n1, n2 \in Nodes :
          \A idx \in Nat :
            /\ idx <= commitIndex[n1]
            /\ idx <= commitIndex[n2]  
            /\ idx > 0
            => log[n1][idx] = log[n2][idx]

  - name: "EventualLeaderElection"
    type: "liveness"
    natural_language: "Eventually, a leader will be elected if the majority of nodes are functioning"
    formal_description: "Under fair scheduling and with a majority of nodes operational, the system will eventually elect a leader and make progress."
    tla_example: |
      EventualLeaderElection ==
        /\ MajorityNodesUp
        => <>(\E n \in Nodes : serverState[n] = Leader)

metadata:
  total_invariants: 5
  safety_invariants: 4
  liveness_invariants: 1